{% extends "::base.html.twig" %}

{% set foto = '' %}
{% set foto_path = '' %}
{% if foto is defined and foto != '' %}
	{% set span = 'span8' %}
	{% set maxinputspan = 'span4' %}
	{% set midinputspan = 'span2' %}
	{% set maxpspan = 'span7' %}
	{% set span5= 'span3' %}
{% else %}
	{% set span = 'span11' %}
	{% set maxinputspan = 'span6' %}
	{% set midinputspan = 'span3' %}
	{% set maxpspan = 'span10' %}
	{% set span5= 'span5' %}
{% endif %}

{% block body %}

<strong class="title span12">{% block box_title %}{{ formTitleAction }} registro de Perfis de acesso{% endblock %}</strong>

<div class="aba">

	<form action="{{ path('profile_save') }}" method="post" id="j_cadastroForm" enctype="multipart/form-data" style="position: relative;">
		<div class="tab-content box_borda">
		
		<!-- Usuarios OneToOne -->
		<input type="hidden" id="id" name="id" value="{{ entityData.id }}">
		
		<div class="tab-pane active {{ span }} paddingAll" id="tab1">
            <div class="filder {{ span }}">

            	<ul>
            		<li class="span">
            			<h5 class="row {{ maxpspan }} legenda">Dados b치sicos</h5>
            		</li>
            		
            		<input type="hidden" id="idLegalBodyType" name="idLegalBodyType" value="1">
            		
            		<li class="span">
            		  <label class="row span3">Nome:  <font color="red"><b>*</b></font></label>
            		  <input class="{{ maxinputspan }}" name="term" id="term" type="text" value="{{ entityData.term }}" required="required" minlength="3" maxlength="128">
            		</li>
            		
            		<li class="span">
        		        <label class="row span3 visible-phone">Funcionalidades: <font color="red"><b>*</b></font></label>
            		      {% for vall,iitem in formData.functionality %}
    		  	            <label class="row span3 hidden-phone">{% if vall == 1 %}Funcionalidades: <font color="red"><b>*</b></font>{% else %}&nbsp;{% endif %}</label>
                            <label  class="{{ maxinputspan }}" for="func_{{ vall }}">
                                <input {% if vall == 1 %}onclick="markAllSuper(this)"{% endif %} type="checkbox" value="{{ vall }}" name="functionalities[][id]" id="func_{{ vall }}" required="required"
                                {% for pval,ptiem in entityData.functionalities %}
                                    {% if ptiem.id == vall  %}
                                    checked
                                    {% endif %}
                                {% endfor %}
                                > - {{ iitem }}
                            </label>
                            {% endfor %}
                		</li>

                </ul>
            </div>
            
        </div>
		
	   <div class="row-fluid pull-left navigation">
		    <a id="cancel_bt" style="margin: 0px 20px;" class="btn pull-left">Cancelar</a>
		    <button type="submit" id="save_bt" class="btn btn-primary pull-right" style="margin: 0px 20px;">Salvar</button>
		</div>
        
	</form>
	
</div>

<script>

    $('.aba').find('.first').addClass('active');

    function fixGrid(grid, pager)
    {
    	$('#' + grid).setGridWidth(10);
        var width = $('#' + pager).parent().parent().width();
        $('#' + grid).setGridWidth(width);
    }

    function fixGrids(e)
    {
    	fixGrid('arqgrid', 'arqpager');
    }

    $(document).on('shown.bs.tab', 'a[data-toggle="tab"]', fixGrids);
    
    $(window).bind('resize', fixGrids);

    function markAllSuper(obj)
    {
    	if ($("#"+obj.id).is(':checked')) {
    		$("#"+obj.id).parent().parent().parent().find(':checkbox').attr('disabled', true);
    		$("#"+obj.id).parent().parent().parent().find(':checkbox').prop('checked', true);
    	}
    	else{
    		$("#"+obj.id).parent().parent().parent().find(':checkbox').attr('disabled', false);
 		    $("#"+obj.id).parent().parent().parent().find(':checkbox').prop('checked', false);
    	}

    	$("#"+obj.id).attr('disabled', false);
    }

    function markIfSuper(obj)
    {
    	if ($("#"+obj.id).is(':checked')) {
    		$("#"+obj.id).parent().parent().parent().find(':checkbox').attr('disabled', true);
    		$("#"+obj.id).parent().parent().parent().find(':checkbox').prop('checked', true);
    	}

    	$("#"+obj.id).attr('disabled', false);
    }

    function checkUniqueUser()
	{
    	$("#waitDialog").modal('show');
    	$.ajax({
            type: "GET",
            url: "{{ path('check_unique_username') }}", 
            data: { 
                id:       $('#id').val(),
                username: $('#username').val(),
            },
            dataType: 'json'
        })
        .success(function(resp) {
        	$("#waitDialog").modal('hide');
        	if (!resp){
    			if ($('label[for="username"]').length == 0)
        			  errorPlacement($('<label for="username" class="error" id="uniqueUser"><span>&#8593;</span> Login j치 cadastrado na base de dados!</label>'), $('#username'));
    			else {
	    			$('label[for="username"]').show();
	    			$('label[for="username"]').html('<span>&#8593;</span> Login j치 cadastrado na base de dados!');
    			}
	    	}
	    	else {
    	    	if ($('label[for="username"]').length > 0) {
    	    	    $('label[id="uniqueUser"]').remove();
    	    	}
	    	}
        }).error(function(data){
            $("#waitDialog").modal('hide');
        });
    }

    $('#j_cadastroForm').submit(function(){
    	checkUniqueUser();
    	var errorUsr = $('label[for="username"]')
    	if (errorUsr.length && errorUsr.css('display') == 'inline'){
      		$("#errorDialogBody").html('Erros encontrados no formul치rio. Corrija-os para prosseguir.');
      	    $("#errorDialog").modal('show');
  	    
    		return false;
        }
    	else{
        	return true;
        } 
    });

    $(document).ready(function() {
        
        $('#username').blur(checkUniqueUser);

        $('input[value="1"]:checkbox').each(function (){markIfSuper($(this)[0])});

    });
    </script>

{% endblock %}